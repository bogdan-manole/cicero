{{template "_layout.html" .}}

{{define "main"}}
	{{$scope := "d2dc0bac8e4747b39b78a49cf274328a"}}

	<div id="{{$scope}}">
		{{with .Instance}}
			<h1>{{.Name}}</h1>

			<ul>
				<li><a href="#">Stop</a></li>
				<li><a href="#">Clone</a></li>
			</ul>

			<ul class="graph-types">
				<li>Type:</li>
				{{range $.graphTypes}}
					<li>
						{{if or (eq . $.graph) (and (eq $.graph "") (eq . "flow"))}}
							{{.}}
						{{else}}
							<a href="?graph={{.}}">{{.}}</a>
						{{end}}
					</li>
				{{end}}
			</ul>
			<iframe src="/workflow/{{.ID}}/graph?type={{$.graph}}"></iframe>

			<table class="table">
				<tr>
					<td>Source</td>
					<td>{{.Source}}</td>
				</tr>
				<tr>
					<td>Created at</td>
					<td>{{.CreatedAt}}</td>
				</tr>
				<tr>
					<td>Updated at</td>
					<td>{{.UpdatedAt}}</td>
				</tr>
				<tr>
					<td>State</td>
					<td><pre>{{.Certs | toJson}}</pre></td>
				</tr>
			</table>
		{{end}}

		<h2 class="h2 pt-2">Actions</h2>
		<div class="tabs" style="--num-tabs: {{print (len .allocs)}}">
			{{range $name, $wrapper := .allocs}}
				<input id="tab-{{$name}}" type="radio" name="tab"/>
				<label for="tab-{{$name}}">{{$name}}</label>
				<div>
					<div data-tab="{{$name}}">
						{{with $wrapper.Alloc}}
							<div class="row pt-2">
								<div class="col-6">
									<h2 class="h2">General Information</h2>
									<dl class="row">
									<dt class="col-sm-2">Status:</dt><dd class="col-sm-10">{{.ClientStatus}}</dd>
									<dt class="col-sm-2">Task Group:</dt><dd class="col-sm-10">{{.TaskGroup}}</dd>
									<dt class="col-sm-2">Created:</dt><dd class="col-sm-10">{{.CreateTime}}</dd>
									<dt class="col-sm-2">Job:</dt><dd class="col-sm-10">{{.JobID}}</dd>
									<dt class="col-sm-2">Node:</dt><dd class="col-sm-10">{{.NodeName}}</dd>
									</dl>
								</div>

								<div class="col-6">
									<h2 class="h2">Allocated Resources</h2>
									<dl class="row">
									<dt class="col-sm-2">Cores:</dt><dd class="col-sm-10">{{.Resources.Cores}}</dd>
									<dt class="col-sm-2">CPU:</dt><dd class="col-sm-10">{{.Resources.CPU}} Mhz</dd>
									<dt class="col-sm-2">Disk:</dt><dd class="col-sm-10">{{.Resources.DiskMB}} MB</dd>
									<dt class="col-sm-2">IOPS:</dt><dd class="col-sm-10">{{.Resources.IOPS}}</dd>
									<dt class="col-sm-2">Memory Max:</dt><dd class="col-sm-10">{{.Resources.MemoryMaxMB}} MB</dd>
									<dt class="col-sm-2">Memory:</dt><dd class="col-sm-10">{{.Resources.MemoryMB}} MB</dd>
									</dl>
								</div>
							</div>

							{{with (index .TaskStates $name)}}
								<dl class="row pt-2">
									<dt class="col-sm-3">Failed:</dt><dd class="col-sm-9">{{.Failed}}</dd>
									<dt class="col-sm-3">State:</dt><dd class="col-sm-9">{{.State}}</dd>
									<dt class="col-sm-3">Started:</dt><dd class="col-sm-9">{{.StartedAt}}</dd>
									{{if and .FinishedAt .StartedAt}}
										<dt class="col-sm-3">Finished:</dt><dd class="col-sm-9">{{.FinishedAt}}</dd>
										<dt class="col-sm-3">Duration:</dt><dd class="col-sm-9">TODO: {{.FinishedAt}} - {{.StartedAt}}</dd>
									{{end}}
									{{if gt .Restarts 0}}
										<dt class="col-sm-3">Restarts:</dt><dd class="col-sm-9">{{.Restarts}}</dd>
										<dt class="col-sm-3">Last Restart:</dt><dd class="col-sm-9">{{.LastRestart}}</dd>
									{{end}}

									{{with (index $wrapper.Alloc.AllocatedResources.Tasks $name)}}
										<dt class="col-sm-3">CPU Shares:</dt><dd class="col-sm-9">{{.Cpu.CpuShares}} Mhz</dd>
										<dt class="col-sm-3">Memory:</dt><dd class="col-sm-9">{{.Memory.MemoryMB}} MB</dd>
										{{if gt .Memory.MemoryMaxMB 0}}
											<dt class="col-sm-3">Memory Max:</dt><dd class="col-sm-9">{{.Memory.MemoryMaxMB}} MB</dd>
										{{end}}
									{{end}}
								</dl>

								<h3 class="h3 pt-2">Event Logs</h3>
								<table class="table table-borderless table-sm">
									{{range .Events}}
										<tr>
											<td class="time">{{.Time}}</td>
											{{if eq .Type "Received" "Task Setup" "Task hook failed" "Started" "Restarting"}}
												<td class="line">{{.DisplayMessage}}</td>
											{{else if eq .Type "Not Restarting"}}
												<td class="line">{{.Type}}: {{.DisplayMessage}}</td>
											{{else if eq .Type "Terminated"}}
												<td class="line">
													{{.Type}}:
													{{range $key, $value := .Details -}}
														{{$key}}: {{$value}},
													{{end}}
												</td>
											{{else}}
												<table class="table">
													<tr>
														<td>type</td>
														<td>details</td>
														<td>disk_limit</td>
														<td>display_message</td>
														<td>download_error</td>
														<td>driver_error</td>
														<td>driver_message</td>
														<td>exit_code</td>
														<td>failed_sibling</td>
														<td>fails_task</td>
														<td>generic_source</td>
														<td>kill_error</td>
														<td>kill_reason</td>
														<td>kill_timeout</td>
														<td>message</td>
														<td>restart_reason</td>
														<td>setup_error</td>
														<td>signal</td>
														<td>start_delay</td>
														<td>task_signal</td>
														<td>task_signal_reason</td>
														<td>validation_error</td>
														<td>vault_error</td>
													</tr>
													<tr>
														<td>{{.Type}}</td>
														<td>
															{{range $key, $value := .Details}}
																{{$key}}: {{$value}}<br/>
															{{end}}
														</td>
														<td>{{.DiskLimit}}</td>
														<td>{{.DisplayMessage}}</td>
														<td>{{.DownloadError}}</td>
														<td>{{.DriverError}}</td>
														<td>{{.DriverMessage}}</td>
														<td>{{.ExitCode}}</td>
														<td>{{.FailedSibling}}</td>
														<td>{{.FailsTask}}</td>
														<td>{{.GenericSource}}</td>
														<td>{{.KillError}}</td>
														<td>{{.KillReason}}</td>
														<td>{{.KillTimeout}}</td>
														<td>{{.Message}}</td>
														<td>{{.RestartReason}}</td>
														<td>{{.SetupError}}</td>
														<td>{{.Signal}}</td>
														<td>{{.StartDelay}}</td>
														<td>{{.TaskSignal}}</td>
														<td>{{.TaskSignalReason}}</td>
														<td>{{.ValidationError}}</td>
														<td>{{.VaultError}}</td>
													</tr>
												</table>
											{{end}}
										</tr>
									{{end}}
								</table>
							{{end}}
						{{end}}

						<h3 class="h3">Task Logs</h3>

						<table class="table table-borderless table-sm">
							{{range $wrapper.Logs.Stdout}}
								<tr class="text-body">
								<td class="time">{{.Time.Format "2006-01-02 15:04:05"}}</td>
								<td class="line">{{.Text}}</td>
								</tr>
							{{end}}
						</table>

						<table class="table table-borderless table-sm">
							{{range $wrapper.Logs.Stderr}}
								<tr class="text-danger">
								<td class="time">{{.Time.Format "Jan 02, 2006"}}</td>
								<td class="line">{{.Text}}</td>
								</tr>
							{{end}}
						</table>
					</div>
				</div>
			{{end}}
		</div>
	</div>

	<style>
	#{{$scope}} {
		height: 100%;

		display: flex;
		flex-direction: column;
	}

	#{{$scope}} > iframe {
		flex-grow: 1;
		border: 5px groove var(--border);
		padding: 1%;
		min-height: 33vh;
	}

	#{{$scope}} ul.graph-types {
		display: flex;
		list-style: none;
		gap: 1%;
	}

	#{{$scope}} .tabs {
		display: grid;
		grid-template-rows: auto 1fr;
	}

	#{{$scope}} .tabs > label {
		grid-row: 1;
		border-bottom: 1px solid var(--border);
		text-align: center;
		border-radius: 5px 5px 0 0;
	}

	#{{$scope}} .tabs > input {
		display: none;
	}

	#{{$scope}} .tabs > input:checked + label {
		border: 2px solid var(--border);
		border-bottom: none;
	}

	#{{$scope}} .tabs > div {
		grid-row: 2;
		grid-column: 1 / calc(var(--num-tabs) + 1);
		display: none;
	}

	#{{$scope}} .tabs > input:checked + label + div {
		display: block;
	}

	#{{$scope}} td.time, td.line {
		font-size: 0.7em;
	}

	#{{$scope}} td.time {
		white-space: nowrap;
		user-select: none;
		width: 7em;
	}

	#{{$scope}} td.line {
		font-family: "SFMono-Regular", Monaco, Menlo, Consolas, "Liberation Mono", Courier, monospace;
		white-space: pre-wrap;
		vertical-align: middle;
		word-break: break-word;
		overflow-wrap: break-word;
	}
	</style>
{{end}}
